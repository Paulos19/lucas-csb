// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// O Corretor (Usuário do Sistema)
model User {
  id       String  @id @default(cuid())
  name     String
  email    String  @unique
  password String
  phone    String  @unique // Telefone da Instância do WhatsApp

  // Configurações do Agente Lucas
  welcomeMessage            String? // Mensagem inicial personalizada
  ragKnowledgeBaseCondensed Json?   // Base de conhecimento (RAG) resumida para a IA
  
  // Relacionamentos
  leads             Lead[]
  products          InsuranceProduct[]
  agendamentos      Agendamento[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// O Produto (Seguro) - Anteriormente "Product"
model InsuranceProduct {
  id             String @id @default(cuid())
  name           String // Ex: "Seguro Residencial Bradesco"
  description    String @db.Text // Descrição para a IA usar como base
  monthlyPremium Float  // Preço base
  
  // Argumentos de Venda (O "Cérebro" de vendas específico deste produto)
  coverages      Json?  // Coberturas para a IA citar
  assistances    Json?  // Assistências para a IA citar

  status String @default("ACTIVE")

  userId String
  user   User   @relation(fields: [userId], references: [id])
  leads  Lead[] @relation("Interest")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// O Cliente (Lead) - Anteriormente "Client"
model Lead {
  id      String     @id @default(cuid())
  name    String
  contato String     @unique // WhatsApp do cliente
  status  LeadStatus @default(ENTRANTE) // Status do Funil

  // Controle de Prospecção (Scheduler)
  firstContactSent Boolean @default(false) // Marcado como true após o Lucas enviar o "Oi"

  // Memória e Contexto
  dynamicData       Json?   // Guarda e-mail, nome confirmado, etc.
  historicoCompleto Json?   // Histórico do chat para o RAG
  resumoDaConversa  String? @db.Text

  // Vínculos
  userId String
  user   User   @relation(fields: [userId], references: [id])

  interestedInProductId String?
  interestedInProduct   InsuranceProduct? @relation("Interest", fields: [interestedInProductId], references: [id])

  agendamento Agendamento?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Novo Modelo de Agendamento
model Agendamento {
  id       String   @id @default(cuid())
  dataHora DateTime
  tipo     String   @default("REUNIAO_VENDAS")
  status   String   @default("CONFIRMADO")
  resumo   String?  @db.Text // Resumo gerado pela IA

  leadId String @unique
  lead   Lead   @relation(fields: [leadId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum LeadStatus {
  ENTRANTE
  EM_NEGOCIACAO      // Lucas conversando
  AGENDADO_COTACAO   // Sucesso: Agendou reunião
  NAO_INTERESSADO    // Declinou
  VENDIDO            // Finalizado
  ARQUIVADO
}